kind: pipeline
type: docker
name: commune-page

steps:
  - name: build
    image: plugins/docker
    settings:
      registry: ghcr.io
      username: ${DRONE_COMMIT_AUTHOR}
      password:
        from_secret: DOCKER_TOKEN
      repo: ghcr.io/agicommies/commune-page
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_COMMIT_SHA:0:7}
      dockerfile: docker/Dockerfile
      build_args: APP_NAME=commune-page

  - name: deploy
    image: digitalocean/doctl:latest
    environment:
      DO_CTL_TOKEN:
        from_secret: DO_CTL_TOKEN
    commands:
      - export PATH=$PATH:/app
      - app_name=$( [ "$DRONE_BRANCH" = "main" ] && echo "commune-page" || echo "dev-commune-page" )
      - app_id=$(doctl apps list -t $DO_CTL_TOKEN | grep $app_name | awk '{print $1}')
      - doctl apps create-deployment --wait -t $DO_CTL_TOKEN $app_id

depends_on: []

trigger:
  branch:
    - drone
    - main
    - dev
  event:
    - push
  paths:
    exclude:
      - apps/commune-governance/**
      - apps/commune-validator/**
      - apps/communex-page/**
      - apps/comrads-worker/**
      - apps/sample-app/**
---
kind: pipeline
type: docker
name: community-validator and worker

steps:
  - name: app-build
    image: plugins/docker
    settings:
      registry: ghcr.io
      username: ${DRONE_COMMIT_AUTHOR}
      password:
        from_secret: DOCKER_TOKEN
      repo: ghcr.io/agicommies/community-validator
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_COMMIT_SHA:0:7}
      dockerfile: docker/Dockerfile
      build_args: APP_NAME=commune-validator
    when:
      paths:
        exclude:
          - apps/comrads-worker/**

  - name: worker-build
    image: plugins/docker
    settings:
      registry: ghcr.io
      username: ${DRONE_COMMIT_AUTHOR}
      password:
        from_secret: DOCKER_TOKEN
      repo: ghcr.io/agicommies/comrads-worker
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_COMMIT_SHA:0:7}
      dockerfile: docker/Dockerfile
      build_args: APP_NAME=comrads-worker
    when:
      paths:
        exclude:
          - apps/commune-validator/**

  - name: deploy
    image: digitalocean/doctl:latest
    environment:
      DO_CTL_TOKEN:
        from_secret: DO_CTL_TOKEN
    commands:
      - export PATH=$PATH:/app
      - app_name=$( [ "$DRONE_BRANCH" = "main" ] && echo "community-validator" || echo "dev-community-validator" )
      - app_id=$(doctl apps list -t $DO_CTL_TOKEN | grep $app_name | awk '{print $1}')
      - doctl apps create-deployment --wait -t $DO_CTL_TOKEN $app_id
    depends_on:
      - app-build
      - worker-build

depends_on: []

trigger:
  branch:
    - drone
    - main
    - dev
  event:
    - push
  paths:
    exclude:
      - apps/commune-governance/**
      - apps/commune-page/**
      - apps/communex-page/**
      - apps/sample-app/**
---
kind: pipeline
type: docker
name: commune-governance

steps:
  - name: build
    image: plugins/docker
    settings:
      registry: ghcr.io
      username: ${DRONE_COMMIT_AUTHOR}
      password:
        from_secret: DOCKER_TOKEN
      repo: ghcr.io/agicommies/commune-governance
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_COMMIT_SHA:0:7}
      dockerfile: docker/Dockerfile
      build_args: APP_NAME=commune-governance

  - name: deploy
    image: digitalocean/doctl:latest
    environment:
      DO_CTL_TOKEN:
        from_secret: DO_CTL_TOKEN
    commands:
      - export PATH=$PATH:/app
      - app_name=$( [ "$DRONE_BRANCH" = "main" ] && echo "commune-governance" || echo "dev-commune-governance" )
      - app_id=$(doctl apps list -t $DO_CTL_TOKEN | grep $app_name | awk '{print $1}')
      - doctl apps create-deployment --wait -t $DO_CTL_TOKEN $app_id

depends_on: []

trigger:
  branch:
    - drone
    - main
    - dev
  event:
    - push
  paths:
    exclude:
      - apps/commune-page/**
      - apps/commune-validator/**
      - apps/communex-page/**
      - apps/comrads-worker/**
      - apps/sample-app/**
